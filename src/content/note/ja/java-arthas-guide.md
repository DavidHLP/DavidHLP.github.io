---
title: Arthas：Java開発者のための本番環境診断ツール
timestamp: 2026-02-25 00:00:00+08:00
tags: [Java, 運用, トラブルシューティング, Arthas]
description: Alibabaがオープンソースで公開しているJava診断ツールArthasのコア機能、使用シナリオ、ベストプラクティスを詳しく紹介し、開発者が本番の問題を迅速に特定・解決できるよう支援します。
toc: true
---

## はじめに

Javaアプリケーションの開発とメンテナンスにおいて、CPU高騰、メモリリーク、API応答遅延など、様々な本番環境に遭遇します。従来のデバッグ方法はサービスを再起動するかログを追加する必要があり、サービス可用性に影響するだけでなく、問題調査の複雑さが増します。本日は、サービスを再起動せずに这些问题を迅速に特定・解決できる強力なJava診断ツールArthasをご紹介します。

## Arthasとは

ArthasはAlibabaがオープンソースで公開しているJava診断ツールで、Java Instrumentation技術に基づいて実装されており、以下の特徴があります：

- **非侵襲的**：コードの変更やサービスの再起動が不要
- **リアルタイム診断**：JVM状態、メソッド呼び出し、スレッド情報などをリアルタイムで監視
- **コマンドライン対話**：豊富なコマンドを提供し、Tab補完をサポート
- **クロスプラットフォーム**：Linux/Mac/Windowsをサポートし、JDK 6+に対応

 공식 문서에 따르면, Arthas는 다양한 일반적인 문제를 해결하는 데 도움이 됩니다. 클래스 로딩 문제, 코드 디버깅 문제, 성능 모니터링 문제 등이 포함됩니다.

## コア機能の詳細

### 1. Watch：メソッド実行状態の観測

Watchコマンドは主に「メソッド実行瞬間状態」の調査に使用され、指定されたメソッドの呼び出し詳細をリアルタイムでキャプチャします。

**一般的な使用シナリオ**：

| シナリオ分類 | 調査内容 | 実用例 |
|-------------|---------|-------|
| パラメータ異常 | パラメータが改ざん/欠落/形式エラーがないか | Controllerが受け取るHTTPパラメータ、RPC呼び出しパラメータが期待通りか確認 |
| 戻り値問題 | 結果为空、データエラー、タイプ不一致 | DAOクエリ結果、サードパーティAPI応答、キャッシュ戻り値をチェック |
| 隠蔽例外 | 例外が飲み込まれる、ログスタックトレースが不完全 | `-e`でNPE/ビジネス例外をキャプチャし、トリガー時の完全スタックとパラメータスナップショットを取得 |
| 条件ロジック検証 | ビジネス分支が预期通りにトリガーされるか | 「クーポンが生效」「権限チェックがtrue/falseを返す」などを検証 |
| データフロー追跡 | パラメータが多层呼び出しで修改されるか | Service → DAOレイヤー引数渡の一貫性を監視 |

**例**：
```bash
# 注文サービス.createOrderメソッドの引数と戻り値を監視
watch com.example.OrderService createOrder '{params[0], params[1], returnObj}'
```

### 2. Trace：メソッド呼び出しパス追跡

Traceコマンドは「メソッド内部呼び出しパスを追跡し各ノードの消費時間を統計（トップダウン）」に使用され、時間を消費するノードと例外パスを正確に特定します。

**一般的な使用シナリオ**：

| 調査タイプ | 典型的な問題 | Trace解決策 |
|----------|------------|-------------|
| API性能ボトルネック | 「我的注文」APIがピーク時に偶発的にタイムアウト（>3秒） | getUserOrdersの完全呼び出しチェーンを追跡し、在庫/クーポンサービス呼び出しの異常な時間消費を特定 |
| 慢メソッド根本原因 | 某メソッドは平均消費時間が高いがログ詳細がない | メソッド内の各層呼び出しの消費時間を出力（例：24行目でprimeFactors()を呼び出し1.27ms消費） |
| 例外コンテキスト復元 | NullPointerExceptionだがスタックトレースが不完全 | 例外発生時の完全呼び出しパスと各ノードの消費時間をキャプチャし、现场を迅速に特定 |
| 条件トリガー分析 | 消費時間>100msの例外呼び出しのみ关注 | trace *StringUtils isBlank '#cost>100'でスパイクリクエストを正確にフィルタ |
| 複雑なロジック検証 | ビジネス分支が预期通りに実行されるか | メソッド内のすべての分支呼び出しパスを視覚的に表示し、ロジックフローを検証 |

**例**：
```bash
# 注文処理で100msを超える呼び出しパスを追跡
trace com.example.OrderProcessor processOrder '#cost>100'
```

### 3. Stack：メソッド呼び出しパスの復元

Stackコマンドは「指定されたメソッドが呼び出される完全な呼び出しパス（ボトムアップ）」を追跡します。

**一般的な使用シナリオ**：

| 調査シナリオ | 問題特性 | Stack解決策 |
|------------|---------|------------|
| 呼び出し元特定 | 共通メソッドが複数から呼び出され、具体的なトリガー側を特定必要 | 完全な呼び出しスタックを出力：CustomRealm.ldapLogin → SystemPersonalController.ldapServerConfigConnectionTest |
| 例外パス復元 | メソッド動作が異常だが何がトリガーかわからない | 例外発生時の呼び出しチェーンをキャプチャし、犯行入口を迅速に特定 |
| 性能スパイク追跡 | 共通メソッドが偶発的に消費時間が高く、首謀者を特定必要 | stack XxxService commonMethod '#cost>100'で高消費時間呼び出しをフィルタし、呼び出し元を表示 |
| フレームワークフロー学習 | フレームワーク内部メソッドがどのようにトリガーされるか不明 | Spring AOP、Shiroなどのフレームワークの关键メソッドの呼び出しパスを表示 |
| デッドロック/ブロック分析 | スレッドがブロックされているがブロック点の呼び出しコンテキストを確認必要 | thread -bでブロックスレッドを特定した後、stackでブロックメソッドの呼び出しチェーンを遡及 |

**例**：
```bash
# 注文サービスで頻繁に呼び出される共通メソッドの呼び出しパスを表示
stack com.example.CommonService processOrder
```

### 4. TT：メソッド呼び出しタイムトンネル

TT（TimeTunnel）コマンドは指定されたメソッドの各呼び出しの引数と戻り値を記録し、不同時間でのこれらの呼び出しを観測できます。

**主な機能**：
- メソッド呼び出し履歴を記録
- 履歴呼び出し詳細を表示
- 履歴呼び出しを再現
- 条件式に基づいて呼び出し記録をフィルタ

**例**：
```bash
# 注文サービスの作成メソッドの呼び出し履歴を記録
tt -t com.example.OrderService createOrder

# 最近の呼び出しの詳細を表示
tt -i 1000

# 特定の履歴呼び出しを再現
tt -p -i 1003
```

### 5. Monitor：メソッド実行モニタリング

Monitorコマンドはクラス/メソッドに一致する呼び出しをモニタリングし、呼び出し回数成功率、平均レスポンス時間などの指標を統計します。

**主なモニタリング指標**：
- 呼び出し回数
- 成功/失敗回数
- 平均レスポンス時間
- 失敗率

**例**：
```bash
# 注文サービスの作成メソッドの実行状況をモニタリングし、5秒ごとに統計を出力
monitor -c 5 com.example.OrderService createOrder
```

### 6. システムプロパティとJVM情報

ArthasはJVMシステムプロパティの表示・変更、メモリ情報、スレッド状態などの機能も提供します。

**一般的なコマンド**：
- `sysprop`：JVMシステムプロパティの表示・変更
- `jvm`：現在のJVM情報を表示
- `memory`：JVMメモリ情報を表示
- `thread`：現在のJVMスレッドスタック情報を表示

**例**：
```bash
# すべてのJVMシステムプロパティを表示
sysprop

# 特定のシステムプロパティを表示
sysprop java.version

# システムプロパティを変更
sysprop production.mode true

# JVMメモリ使用情况を表示
memory
```

## 他の診断ツールとの比較

Arthasは他のJava診断ツールと比較して、独自の強みと適用シナリオがあります：

### VisualVMとの比較

| 機能 | Arthas | VisualVM |
|------|--------|----------|
| インストール/使用 | シンプル、ワンボタン起動 | インストールと設定が必要 |
| 本番環境適合性 | 高い、非侵襲的 | 中程度、リソース消費大 |
| リアルタイムモニタリング | コマンドラインリアルタイム更新 | グラフィカルインターフェース、更新时间遅延 |
| リモート診断 | 便利、Telnetベース | 複雑、設定が必要 |
| 機能深度 | 豊富なコマンドラインツール | 強力なグラフィカル分析 |
| 学習コスト | コマンドライン操作、慣れる必要あり | グラフィカルインターフェース、初心者向け |

### JProfilerとの比較

| 機能 | Arthas | JProfiler |
|------|--------|-----------|
| パフォーマンス影響 | 低い、オンデマンド拡張 | 高い、完全モニタリング |
| 本番環境 | 適合、オンライン使用可能 | 非推奨、リソース消費大 |
| サンプリング分析 | 多种多様なサンプリング方法をサポート | フレームグラフなどの高度な分析 |
| コードホットReplacement | サポート | 非サポート |
| 使用门槛 | コマンドライン、學習必要 | グラフィカルインターフェース、比較的シンプル |
| ライセンス費用 | オープンソース、免费 | 商用ライセンス |

### まとめ

- **Arthas**：本番環境のリアルタイム診断により适し、低リソース、非侵襲的な特徴があり、経験豊富な開発者が問題を迅速に特定するのに最適
- **VisualVM**：開発フェーズでの性能分析と問題診断に適し、グラフィカルインターフェースは親切だが、本番環境では注意して使用すべき
- **JProfiler**：詳細な性能分析とチューニNgに适するが、リソース消費が大きく、主に開発テスト環境で使用

## ベストプラクティス

### 1. 本番環境使用時の注意

- **セキュリティ管理**：Arthasポートを制限し、公表网络への露出を回避
- **パフォーマンス影響**：watch/traceコマンドは5%~15%のオーバーヘッドを追加するため、`-n`で出力を制限
- **出力記録**：重要なコマンドは`-o /tmp/arthas.log`で結果を保存
- **リソース解放**：問題解決後、`stop`で適時にリソースを解放

### 2. 問題調査の思路と方法

本番環境に問題がある、以下の步骤でArthasを使用できます：

1. **最初にdashboardを使用**：CPU、メモリ、GC、スレッドなどの基本情報を含むシステム全体 상태を取得
2. **threadコマンドを使用**：スレッド状態を表示し、高CPU使用またはデッドロック問題を特定
3. **trace/monitorを使用**：关键メソッドに対して性能分析を実施し、ボトルネックを特定
4. **watch/TTを使用**：メソッド呼び出しの詳細を观测し、ビジネスロジックを検証
5. **memory/jmapを使用**：メモリ使用状況を分析し、メモリリークを調査

### 3. 一般的な問題の解決策

**CPU高騰問題**：
```bash
# 1. システム状態を表示
dashboard

# 2. スレッドスタックを表示し、高CPU占用のスレッドを特定
thread -b

# 3. 时间消費の多いメソッドを追跡
trace *Service *Method '#cost>100'

# 4. メソッド実行状況をモニタリング
monitor -c 5 com.example.HighCpuMethod
```

**メモリリーク問題**：
```bash
# 1. メモリ使用状況を表示
memory

# 2. ヒープメモリ使用を表示
heapdump

# 3. オブジェクト参照チェーンを分析
vmtool --action referenceAnalyze --className com.example.LeakedClass

# 4. GC状況をモニタリング
jvm -g
```

**API応答遅延問題**：
```bash
# 1. メソッド呼び出しパスを追跡
trace com.example.SlowService slowMethod

# 2. メソッド実行時間をモニタリング
monitor -c 10 com.example.SlowService slowMethod

# 3. メソッド呼び出しの詳細を観測
watch com.example.SlowService slowMethod '{params[0], returnObj, cost}'
```

## 結論

Arthasは、非侵襲的、リアルタイム診断的特点を持ち、Java開発者が本番問題を解決するための強力なツールです。本文的介绍を通じて、Arthasのコア機能について理解を深めていただけたと思います。Watch、Trace、Stack、TT、Monitorなどのコマンドの使用シナリオと実践例が含まれています。

他の診断ツールと比較して、Arthasは本番環境で明らかな优势を持ち、リアルタイム診断と問題調査が必要なシナリオに特化して適しています。実際の使用では、システム提供の他のツールと組み合わせることで、より効率的に様々なJavaアプリケーションの問題を特定・解決できます。

本文の内容がArthasの理解と使用の改善皆様有所帮助し、Javaアプリケーションの可観測性と問題調査效率を向上させることを望んでいます。Arthasを試したことがない方は、次のプロジェクトで試してみることを强烈に推奨します。
